name: pcie-comm-server
run-name: PCIe Communication Server
on: [push, pull_request]
jobs:
  Build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - run: |
          sudo apt-get update -qq
          sudo apt-get upgrade -y -qq
          sudo apt-get install -y -qq cmake git lcov
      - run: pip3 install -e git+https://github.com/antmicro/tuttest#egg=tuttest
      - run: tuttest README.md server-build | bash -o pipefail -
      - run: |
          ./build/server-tests
          ./scripts/coverage.sh
          tar czf coverage.tar.gz coverage
      - uses: actions/upload-artifact@v3
        with:
          path: |
              ./build/server
              ./build/server-tests
              ./coverage.tar.gz

  Checkpatch:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - run: |
          sudo apt-get update -qq
          sudo apt-get upgrade -y -qq
          sudo apt-get install -y -qq wget perl
      - run: |
          wget https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/scripts/checkpatch.pl
          chmod +x checkpatch.pl
      - run: find . -iname '*.[ch]' -not -path "./build/*" -and -not -path "./tests/*" -and -not -path "./zephyr-samples/drivers/dma/*" | xargs ./checkpatch.pl -f --no-tree

  Zephyr-Samples:
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/zephyrproject-rtos/ci:v0.26.2
      options: --cap-add=NET_ADMIN --device /dev/net/tun:/dev/net/tun
    env:
      CMAKE_PREFIX_PATH: /opt/toolchains
    steps:
      - uses: actions/checkout@v3
      - run: |
          pip3 install -e git+https://github.com/antmicro/tuttest#egg=tuttest
          tuttest zephyr-samples/pcie_scan/README.md pcie-scan-prep | bash -o pipefail -
      - run: |
          tuttest zephyr-samples/pcie_scan/README.md pcie-scan-build | bash -o pipefail -
          tar czf pcie_scan.tar.gz build.pcie_scan
      - run: |
          tuttest zephyr-samples/pcie_nvme/README.md pcie-nvme-build | bash -o pipefail -
          tar czf pcie_nvme.tar.gz build.pcie_nvme
      - run: |
          tuttest zephyr-samples/pcie_ivshmem/README.md pcie-ivshmem-build | bash -o pipefail -
          tar czf pcie_ivshmem.tar.gz build.pcie_ivshmem
      - run: |
          tuttest zephyr-samples/pcie_dma/README.md pcie-dma-build | bash -o pipefail -
          tar czf pcie_dma.tar.gz build.pcie_dma
          tuttest zephyr-samples/pcie_dma/README.md pcie-dma-memory-mock,pcie-dma-net-setup,pcie-dma-run,pcie-dma-teardown | bash -o pipefail -

      - uses: actions/upload-artifact@v3
        with:
          path: |
              ./pcie_*.tar.gz
